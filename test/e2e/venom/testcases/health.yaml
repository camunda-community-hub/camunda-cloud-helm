name: Preflight Checks

vars:
  releaseName: e2e

testcases:

- name: Readiness - Dependencies
  steps:
  - name: "{{ .value.component }}"
    type: http
    range:
    - component: Keycloak
      url: http://{{ .releaseName }}-keycloak/auth/realms/master
    - component: Elasticsearch
      url: "http://elasticsearch-master:9200/_cluster/health?&timeout=1s"
    method: GET
    url: "{{ .value.url }}"
    retry: 3
    delay: 10
    info: "{{ .value.component }} URL: {{ .value.url }}"
    assertions:
    - result.statuscode ShouldEqual 200

- name: Readiness - Camunda
  steps:
  - name: "{{ .value.component }}"
    type: http
    range:
    # TODO: Fix this by exposing health port in Identity service.
    # - component: Identity
    #   url: http://{{ .releaseName }}-identity:8082/actuator/health
    - component: Optimize
      url: http://{{ .releaseName }}-optimize/api/readyz
    - component: Operate
      url: http://{{ .releaseName }}-operate/actuator/health/readiness
    - component: Tasklist
      url: http://{{ .releaseName }}-tasklist/actuator/health/readiness
    - component: Zeebe-Gateway
      url: http://{{ .releaseName }}-zeebe-gateway:9600/health
    method: GET
    url: "{{ .value.url }}"
    retry: 3
    delay: 10
    info: "{{ .value.component }} URL: {{ .value.url }}"
    assertions:
    - result.statuscode ShouldEqual 200
