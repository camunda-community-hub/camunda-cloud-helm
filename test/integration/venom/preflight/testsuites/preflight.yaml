name: Preflight checks for Camunda Platform

vars:
  releaseName: '{{ .RELEASE_NAME | default "integration" }}'

testcases:

- name: Readiness
  steps:
  - name: "{{ .value.component }}"
    type: http
    range:
    # Dependencies.
    - component: Keycloak
      url: http://{{ .releaseName }}-keycloak/auth/realms/master
    - component: Elasticsearch
      url: "http://elasticsearch-master:9200/_cluster/health?&timeout=1s"
    # Camunda.
    - component: Identity
      url: http://{{ .releaseName }}-identity:82/actuator/health
    - component: Optimize
      url: http://{{ .releaseName }}-optimize/api/readyz
    - component: Operate
      url: http://{{ .releaseName }}-operate/actuator/health/readiness
    - component: Tasklist
      url: http://{{ .releaseName }}-tasklist/actuator/health/readiness
    - component: Zeebe-Gateway
      url: http://{{ .releaseName }}-zeebe-gateway:9600/health
    method: GET
    url: "{{ .value.url }}"
    retry: 3
    delay: 10
    info: "{{ .value.component }} URL: {{ .value.url }}"
    assertions:
    - result.statuscode ShouldEqual 200

# TODO: Check Liveness endpoints.
# - name: Liveness
